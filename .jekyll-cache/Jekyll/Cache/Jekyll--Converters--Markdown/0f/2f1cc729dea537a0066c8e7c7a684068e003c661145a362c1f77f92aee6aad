I"Ñ$<p><img src="https://miro.medium.com/max/700/1*rG6GnMOz0nlRUUU1Va7aTA.jpeg" alt="Container House" /></p>

<p><a href="https://medium.com/@jrperin1975/docker-accessing-host-database-49e1ff92a40"><strong>Acesse meu Medium e veja vers√£o em Ingl√™s</strong></a></p>

<hr />

<h2 id="introdu√ß√£o">Introdu√ß√£o</h2>

<p>Atualmente ao desenvolver uma aplica√ß√£o, <strong>√© imposs√≠vel</strong> n√£o pensar em embarc√°-la em um <strong>cont√™iner</strong>.</p>

<p>A conteineriza√ß√£o das nossas aplica√ß√µes traz ganhos como padroniza√ß√£o, portabilidade, automatiza√ß√£o que facilitam em muito o deploy.
Mas uma quest√£o sempre fica rondando, at√© onde devemos levar para cont√™ineres?</p>

<p>Na minha opini√£o estruturas de bancos de dados como Mysql, Mariadb, MongoDb quando em produ√ß√£o, deveriam ter recursos mais dedicados a eles, mais ‚Äúbare metal‚Äù. Aqui n√£o estou considerando recursos de bancos de dados gerenciados pelos provedores de cloud como AWS, Google, Azure. Estou considerando que a gest√£o dos recursos dos bancos de dados √© feita por voc√™.</p>

<p>Claro que se estivermos falando em ambiente de desenvolvimento, o cen√°rio √© outro.</p>

<p>Colocar os recursos de banco de dados em cont√™ineres, facilita muito para o desenvolvedor ter um um ambiente rodando. Sem que ele tenha que se preocupar com a infraestrutura.</p>

<p>Para que um uma aplica√ß√£o docker possa acessar o ‚Äúmundo externo‚Äù √© preciso informar para ela o IP do host (do hospedeiro).</p>

<p>No <code class="language-plaintext highlighter-rouge">docker-compose</code> isso √© feito pelo membro <code class="language-plaintext highlighter-rouge">extra_hosts</code> ou via linha de comando com o par√¢metro <code class="language-plaintext highlighter-rouge">--add-hosts</code>, que adiciona o endere√ßo ao DNS interno do Docker.</p>

<p>Nesse <em>case</em>, vou focar no <strong>docker-compose</strong>.</p>

<p><strong>Resumo dos passos que ser√£o dados:</strong></p>

<ol>
  <li>
    <p>Instalar o banco de dados Mariadb em um computador com Ubuntu que ser√° a m√°quina hospedeira.</p>
  </li>
  <li>
    <p>Criar um cont√™iner com ferramentas para acessar o banco de dados Mariadb do hospedeiro (Dockerfile e docker-compose.yml).</p>
  </li>
  <li>
    <p>Alterar as permiss√µes do usu√°rio root do banco de dados para permitir acesso do <strong>IP docker</strong> atribu√≠do ao host.</p>
  </li>
  <li>
    <p>Alterar o <strong>bind-address</strong> do banco de dados para permitir acesso atrav√©s do <strong>IP docker do host</strong>.</p>
  </li>
  <li>
    <p>Validar, fazendo o teste de conex√£o do cont√™iner para o host.</p>
  </li>
</ol>

<h2 id="execu√ß√£o">Execu√ß√£o</h2>

<h3 id="1-instalar-mariadb-no-hospedeiro">1. Instalar MariaDB no hospedeiro</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt update
<span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> mariadb-server
</code></pre></div></div>

<h3 id="2-criar-cont√™iner-para-acessar-o-db-no-host">2. Criar cont√™iner para acessar o DB no host</h3>

<p>Criar o arquivo <strong>Dockerfile</strong>:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FROM ubuntu
RUN apt update <span class="o">&amp;&amp;</span> apt <span class="nb">install</span> <span class="nt">-y</span> iputils-ping net-tools telnet vim mysql-client
</code></pre></div></div>

<p>Criar o arquivo <strong>docker-compose.yml:</strong></p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">3.9"</span>
<span class="na">services</span><span class="pi">:</span>
    <span class="na">ubuntu</span><span class="pi">:</span>
        <span class="na">build</span><span class="pi">:</span>
            <span class="na">context</span><span class="pi">:</span> <span class="s">./</span>
            <span class="na">dockerfile</span><span class="pi">:</span> <span class="s">Dockerfile</span>
    <span class="na">extra_hosts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">database:172.17.0.1"</span>
</code></pre></div></div>

<p>O que permite acessar o host √© a sess√£o <strong>extra_hosts</strong> no docker-compose.</p>

<p>Algumas abordagens sugerem para colocar o IP externo para <strong>database</strong>, mas essa abordagem pode ser perigosa, pois o IP do servidor ficar√° exposto para a internet.</p>

<p>Outra abordagem diz que as vers√µes mais recentes do docker permitem usar o DNS <strong>host.docker.internal</strong> para acessar o IP da interface de network docker do host, mas estou usando a vers√£o 19.03.8 do docker no linux ubuntu e n√£o foi poss√≠vel acess√°-lo. Por esse motivo, optei por <strong>colocar o n√∫mero de IP diretamente (172.17.0.1)</strong>. Pelo que pude constatar o n√∫mero de IP √© sempre o mesmo nas instala√ß√µes (<em>testei em 2 computadores direfentes‚Ä¶</em>).</p>

<h3 id="3-permiss√µes-do-usu√°rio-root-no-banco-de-dados">3. Permiss√µes do usu√°rio root no Banco de Dados</h3>
<p>Antes de fazer a altera√ß√£o do bind-address (<em>no step seguinte‚Ä¶</em>) √© necess√°rio dar privil√©gio para o usu√°rio root acessar atrav√©s do IP <strong>172.17.0.1</strong>.</p>

<p><strong>Nota:</strong> Uma instala√ß√£o nova do Mariadb <strong>n√£o tem senha</strong> para o usu√°rio root. Caso voc√™ tenha definido uma senha, use o par√¢metro <strong>‚Äò-p‚Äô</strong> para que seja solicitada a senha no login. No exemplo abaixo, vamos aproveitar e definir uma senha para o usu√°rio root na rede <strong>172.17.0.1</strong>.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql <span class="nt">-u</span> root
mysql&gt; grant all privileges on <span class="k">*</span>.<span class="k">*</span> to ‚Äòroot‚Äô@‚Äô172.17.0.1<span class="s1">' identified by ‚Äòmy_password‚Äô;
mysql&gt; flush privileges;
</span></code></pre></div></div>

<p>Caso tamb√©m queira definir a senha para o usu√°rio root na rede localhost (127.0.0.1), repita o comando acima trocando <code class="language-plaintext highlighter-rouge">root</code>@<code class="language-plaintext highlighter-rouge">172.17.0.1</code> por <code class="language-plaintext highlighter-rouge">root</code>@<code class="language-plaintext highlighter-rouge">127.0.0.1</code>.</p>

<p>Caso deseje liberar o acesso ao usuario root para qualquer IP, troque o n√∫mero do IP <code class="language-plaintext highlighter-rouge">172.17.0.1</code> por <code class="language-plaintext highlighter-rouge">%</code>que √© o wild card para ‚Äútudo‚Äù, mas isso n√£o √© uma boa id√©ia, pois pode liberar acesso demais e colocar o sistema em risco.</p>

<h3 id="4-alterar-o-bind-address-do-banco-de-dados">4. Alterar o bind-address do Banco de Dados</h3>

<p>Agora pode ser alterado o endere√ßo do banco de dados para o da interface do docker (172.17.0.1).</p>

<p>Para isso, vamos editar o arquivo <strong>.cnf</strong> que pode variar de local dependendo da instala√ß√£o do banco de dados e do sistema operacional.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim /etc/mysql/mysql.conf.d/mysqld.cnf        &lt;<span class="nt">--</span> Mysql
vim /etc/mysql/mariadb.conf.d/50-server.cnf   &lt;<span class="nt">--</span> Mariadb
vim /etc/my.cnf &lt;<span class="nt">--</span> Red Hat / CentOS<span class="sb">`</span>
<span class="c"># Dentro do arquivo, procurar por:</span>
bind-address <span class="o">=</span> 127.0.0.1
<span class="c"># E mudar para o gateway do doker:</span>
bind-address <span class="o">=</span> 172.17.0.1
<span class="c"># Reiniciar o Mariadb (ou Mysql):</span>
<span class="nb">sudo </span>systemctl restart mysqld
</code></pre></div></div>

<h3 id="5-validar">5. Validar</h3>

<p>Agora vamos validar nossas configura√ß√µes / ambiente.</p>

<p>Primeiramente vamos preparar o ambiente.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose up <span class="nt">--build</span>
</code></pre></div></div>

<p>Ap√≥s esse comando o docker-compose faz o build, sobe e encerra. Isso √© porque a nossa imagem Dockerfile n√£o tem um ENTRYPOIT definido, o que √© esperado para a imagem Ubuntu que usamos.</p>

<p>Vamos validar o a conex√£o:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose run ubuntu bash
</code></pre></div></div>

<p>Com esse comando, abrimos a shell da imagem Ubuntu no docker.</p>

<p>Vamos conectar no Mariadb que est√° no host.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql <span class="nt">-h</span> database <span class="nt">-u</span> root <span class="nt">-p</span>
</code></pre></div></div>

<p>A senha que voc√™ dever√° digitar √© a mesma que foi informada no passo 3 em <code class="language-plaintext highlighter-rouge">'my_password'</code>.</p>

<p>Se tudo ocorreu bem, estamos dentro do banco de dados e podemos validar com o comando:
show databases;
Se conseguir ver os DBs, a valida√ß√£o foi bem sucedida!</p>
:ET